# 支付功能配置说明

## 概述

本系统已集成微信支付和支付宝支付功能，目前处于开发模式，返回模拟数据用于测试。

## 当前状态

### ✅ 已完成功能
- 支付配置管理（后台界面）
- 支付订单创建和管理
- 支付状态查询
- 支付回调处理框架
- 客户端支付界面

### 🚧 开发中功能
- 微信支付SDK集成（当前为模拟模式）
- 支付宝SDK集成（已基本完成）
- 支付回调验证和处理

## 配置步骤

### 1. 数据库初始化
支付相关表已创建：
- `payment_config` - 支付配置表
- `payment_order` - 支付订单表

### 2. 管理后台配置
1. 登录管理后台 (http://localhost:3001)
2. 进入"支付配置"页面
3. 配置微信支付和支付宝参数

### 3. 微信支付配置
**注意：当前为模拟模式**

真实配置需要：
- 微信支付商户号
- 应用ID (AppID)
- 商户私钥
- 平台证书
- APIv3密钥

### 4. 支付宝配置
需要配置：
- 应用ID (AppID)
- 商户私钥
- 支付宝公钥
- 回调地址

## 测试流程

### 客户端支付测试
1. 登录客户端 (http://localhost:3000)
2. 添加商品到购物车
3. 创建订单
4. 进入支付页面
5. 选择支付方式
6. 查看生成的二维码（模拟）

### 管理后台测试
1. 查看支付配置
2. 启用/禁用支付方式
3. 查看支付订单记录

## API接口

### 支付接口
- `POST /api/payment/create` - 创建支付订单
- `GET /api/payment/status/{orderNo}` - 查询支付状态
- `POST /api/payment/cancel/{orderNo}` - 取消支付

### 回调接口
- `POST /api/payment/wechat/notify` - 微信支付回调
- `POST /api/payment/alipay/notify` - 支付宝支付回调

### 配置管理接口
- `GET /api/admin/payment-config/list` - 获取配置列表
- `POST /api/admin/payment-config` - 创建配置
- `PUT /api/admin/payment-config/{id}` - 更新配置

## 生产环境部署

### 1. 申请支付资质
- 微信支付：申请微信支付商户号
- 支付宝：申请支付宝开放平台应用

### 2. 获取证书和密钥
- 下载相关证书文件
- 生成应用私钥和公钥

### 3. 配置回调地址
确保回调地址可以被支付平台访问：
- 微信支付回调：`https://yourdomain.com/api/payment/wechat/notify`
- 支付宝回调：`https://yourdomain.com/api/payment/alipay/notify`

### 4. 更新配置
在管理后台更新真实的支付配置参数

## 安全注意事项

1. **私钥保护**：确保私钥文件安全存储
2. **HTTPS部署**：生产环境必须使用HTTPS
3. **回调验证**：验证支付回调的签名
4. **订单验证**：验证订单金额和状态
5. **日志记录**：记录所有支付相关操作

## 故障排查

### 常见问题
1. **编译错误**：检查SDK版本兼容性
2. **配置错误**：验证支付参数正确性
3. **回调失败**：检查网络连接和签名验证
4. **订单状态异常**：检查数据库事务处理

### 日志查看
查看应用日志中的支付相关信息：
```
grep "payment\|Payment" logs/application.log
```

## 开发计划

### 短期计划
- [ ] 完善微信支付SDK集成
- [ ] 实现支付回调验证
- [ ] 添加支付失败重试机制

### 长期计划
- [ ] 支持更多支付方式
- [ ] 添加支付统计报表
- [ ] 实现自动对账功能
- [ ] 支持分账和退款

## 联系支持

如有问题，请查看：
1. 微信支付官方文档
2. 支付宝开放平台文档
3. 项目README文件
