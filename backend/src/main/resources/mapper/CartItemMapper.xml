<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.papercup.mapper.CartItemMapper">

    <!-- 结果映射 -->
    <resultMap id="CartItemWithProductMap" type="com.papercup.entity.CartItem">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="product_id" property="productId"/>
        <result column="quantity" property="quantity"/>
        <result column="custom_options" property="customOptions"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        
        <!-- 嵌套产品对象 -->
        <association property="product" javaType="com.papercup.entity.Product">
            <id column="product_id" property="id"/>
            <result column="product_name" property="name"/>
            <result column="product_description" property="description"/>
            <result column="product_price" property="price"/>
            <result column="product_original_price" property="originalPrice"/>
            <result column="product_stock" property="stock"/>
            <result column="product_sales" property="sales"/>
            <result column="product_images" property="images"/>
            <result column="product_specifications" property="specifications"/>
            <result column="product_customizable" property="customizable"/>
            <result column="product_custom_options" property="customOptions"/>
            <result column="product_status" property="status"/>
        </association>
    </resultMap>

    <!-- 查询用户购物车列表（包含产品信息） -->
    <select id="selectCartItemsWithProduct" resultMap="CartItemWithProductMap">
        SELECT 
            c.id,
            c.user_id,
            c.product_id,
            c.quantity,
            c.custom_options,
            c.created_time,
            c.updated_time,
            p.id as product_id,
            p.name as product_name,
            p.description as product_description,
            p.price as product_price,
            p.original_price as product_original_price,
            p.stock as product_stock,
            p.sales as product_sales,
            p.images as product_images,
            p.specifications as product_specifications,
            p.customizable as product_customizable,
            p.custom_options as product_custom_options,
            p.status as product_status
        FROM cart_item c
        LEFT JOIN product p ON c.product_id = p.id
        WHERE c.user_id = #{userId}
        ORDER BY c.created_time DESC
    </select>

</mapper>
